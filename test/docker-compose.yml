services:
  clickhouse-dash:
    image: clickhouse-dash:latest
    build:
        context: ../
        dockerfile: ./test/Dockerfile
        target: production
    container_name: clickhouse-dash
    restart: unless-stopped
    environment:
        CH_URL: "clickhouse:9000"
        CH_USER: "test"
        CH_PASS: "test"
        LISTEN_HOST: "0.0.0.0"
        LISTEN_PORT: ${PORT:-8080}
    ports:
        - 8080:${PORT:-8080}
    depends_on:
        clickhouse:
          condition: service_healthy
    # healthcheck:
    #     test: ["CMD", "wget", "-qO-", "http://127.0.0.1:${PORT:-8080}/healthz"]
    #     interval: 10s
    #     timeout: 3s
    #     retries: 10

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    ports:
      - "8123:8123"   # HTTP
      - "9000:9000"   # Native
    environment:
      CLICKHOUSE_USER: test
      CLICKHOUSE_PASSWORD: test
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query 'SELECT 1' | grep -q '1'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped